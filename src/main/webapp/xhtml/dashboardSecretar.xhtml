<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/WEB-INF/Templates/layout.xhtml">

    <ui:define name="title">Dashboard Secretar</ui:define>
    <ui:define name="header_title">Dashboard Secretar</ui:define>

    <ui:define name="content">
        <p:growl id="messages" globalOnly="true" showDetail="true" closable="true"/>

        <p:tabView>
            <p:tab title="Datele Organizației">
                <h:form id="orgForm">
                    <p:panel header="Date Organizație">
                        <p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank form-grid">
                            <p:outputLabel value="CIF:"/>
                            <h:outputText value="#{dashboardSecretarBean.organizatie.cif}" style="font-weight:bold;"/>
                            <p:outputLabel for="nume" value="Nume Organizație:"/>
                            <h:panelGroup>
                                <h:outputText value="#{dashboardSecretarBean.organizatie.nume}"
                                              rendered="#{not dashboardSecretarBean.editMode}"/>
                                <p:inputText id="nume" value="#{dashboardSecretarBean.organizatie.nume}"
                                             rendered="#{dashboardSecretarBean.editMode}" required="true"/>
                            </h:panelGroup>
                            <p:outputLabel for="adresa" value="Adresă:"/>
                            <h:panelGroup>
                                <h:outputText value="#{dashboardSecretarBean.organizatie.adresa}"
                                              rendered="#{not dashboardSecretarBean.editMode}"/>
                                <p:inputText id="adresa" value="#{dashboardSecretarBean.organizatie.adresa}"
                                             rendered="#{dashboardSecretarBean.editMode}" required="true"/>
                            </h:panelGroup>
                            <p:outputLabel for="email" value="Email Contact:"/>
                            <h:panelGroup>
                                <h:outputText value="#{dashboardSecretarBean.organizatie.mail}"
                                              rendered="#{not dashboardSecretarBean.editMode}"/>
                                <p:inputText id="email" value="#{dashboardSecretarBean.organizatie.mail}"
                                             rendered="#{dashboardSecretarBean.editMode}" required="true"/>
                            </h:panelGroup>
                        </p:panelGrid>
                        <f:facet name="footer">
                            <p:commandButton value="Editează" icon="pi pi-pencil"
                                             action="#{dashboardSecretarBean.activeazaEditare}"
                                             rendered="#{not dashboardSecretarBean.editMode}" update="@form"/>
                            <p:commandButton value="Salvează Modificările" icon="pi pi-save"
                                             action="#{dashboardSecretarBean.salveazaDateOrganizatie}"
                                             rendered="#{dashboardSecretarBean.editMode}" update="@form :messages"/>
                            <p:commandButton value="Anulează" icon="pi pi-times"
                                             action="#{dashboardSecretarBean.anuleazaEditare}"
                                             rendered="#{dashboardSecretarBean.editMode}" update="@form" process="@this"
                                             styleClass="ui-button-secondary" style="margin-left: 5px;"/>
                        </f:facet>
                    </p:panel>
                </h:form>
            </p:tab>

            <p:tab title="Management Departamente">
                <h:form>
                    <p:panel header="Management departamente - listă">
                        <p:commandButton value="Adaugă Departament Nou" icon="pi pi-plus"
                                         type="button" onclick="PF('addDepartamentDialog').show()"/>
                    </p:panel>
                </h:form>

                <h:form id="departamentListForm">
                    <p:dataTable var="dept" value="#{dashboardSecretarBean.departamente}" style="margin-top: 20px;"
                                 emptyMessage="Nu există departamente create.">

                        <p:column headerText="ID" style="width:5rem">
                            <h:outputText value="#{dept.id}"/>
                        </p:column>
                        <p:column headerText="Nume Departament">
                            <h:outputText value="#{dept.nume}"/>
                        </p:column>
                        <p:column headerText="Descriere">
                            <h:outputText value="#{dept.descriere}"/>
                        </p:column>
                        <p:column headerText="Coordonator">
                            <h:outputText value="#{dept.coordonator != null ? dept.coordonator.numeComplet : '-'}"/>
                        </p:column>
                        <p:column headerText="Acțiuni" style="width:8rem; text-align:center;">
                            <p:commandButton icon="pi pi-pencil" title="Editează Departament"
                                             actionListener="#{dashboardSecretarBean.prepareEditDepartament(dept)}"
                                             oncomplete="PF('editDepartamentDialog').show()"
                                             update=":editDepartamentForm"
                                             disabled="#{dept.nume == 'Nerepartizat'}"/>

                            <p:commandButton icon="pi pi-trash" title="Șterge Departament"
                                             oncomplete="PF('confirmStergeDialog').show()"
                                             styleClass="ui-button-danger" style="margin-left: 5px;"
                                             disabled="#{dept.nume == 'Nerepartizat'}">
                                <f:setPropertyActionListener value="#{dept}"
                                                             target="#{dashboardSecretarBean.selectedDepartament}"/>
                            </p:commandButton>
                        </p:column>
                    </p:dataTable>
                </h:form>
            </p:tab>

            <p:tab title="Management Voluntari">
                <h:form id="voluntarForm">
                    <p:dataTable id="voluntariTable" widgetVar="voluntariTable"
                                 var="voluntar" value="#{dashboardSecretarBean.voluntari}"
                                 filteredValue="#{dashboardSecretarBean.filteredVoluntari}"
                                 reflow="true" emptyMessage="Nu există voluntari înregistrați.">

                        <p:column headerText="Nume Complet" sortBy="#{voluntar.numeComplet}"
                                  filterBy="#{voluntar.numeComplet}" filterMatchMode="contains">
                            <h:outputText value="#{voluntar.numeComplet}"/>
                        </p:column>

                        <p:column headerText="Departament"
                                  filterBy="#{voluntar.departament}"
                                  filterMatchMode="exact">

                            <f:facet name="filter">
                                <p:selectOneMenu onchange="PF('voluntariTable').filter()"
                                                 converter="omnifaces.SelectItemsConverter"
                                                 style="width:100%">
                                    <f:selectItem itemLabel="Toate" itemValue="#{null}" noSelectionOption="true"/>
                                    <f:selectItems value="#{dashboardSecretarBean.departamente}" var="d"
                                                   itemLabel="#{d.nume}" itemValue="#{d}"/>
                                </p:selectOneMenu>
                            </f:facet>

                            <h:outputText value="#{voluntar.departament.nume}"/>
                        </p:column>

                        <p:column headerText="Rol" filterBy="#{voluntar.user.rol}" filterMatchMode="exact">
                            <f:facet name="filter">
                                <p:selectOneMenu onchange="PF('voluntariTable').filter()" style="width:100%">
                                    <f:selectItem itemLabel="Toate" itemValue="#{null}" noSelectionOption="true"/>
                                    <f:selectItems value="#{dashboardSecretarBean.roluriAtribuibile}"/>
                                </p:selectOneMenu>
                            </f:facet>
                            <h:outputText value="#{voluntar.user.rol}"/>
                        </p:column>

                        <p:column headerText="Status" filterBy="#{voluntar.status}" filterMatchMode="exact">
                            <f:facet name="filter">
                                <p:selectOneMenu onchange="PF('voluntariTable').filter()" style="width:100%">
                                    <f:selectItem itemLabel="Toate" itemValue="#{null}" noSelectionOption="true"/>
                                    <f:selectItems value="#{dashboardSecretarBean.statusValues}"/>
                                </p:selectOneMenu>
                            </f:facet>
                            <h:outputText value="#{voluntar.status}"/>
                        </p:column>

                        <p:column headerText="Acțiuni" exportable="false" style="width:6rem; text-align:center;">
                            <p:commandButton icon="pi pi-pencil" title="Editează"
                                             actionListener="#{dashboardSecretarBean.prepareEdit(voluntar)}"
                                             oncomplete="PF('editDialog').show()"
                                             update=":editDialogComponent"/>
                            <p:commandButton icon="pi pi-trash" title="Șterge Voluntar"
                                             oncomplete="PF('confirmStergeVoluntarDialog').show()"
                                             styleClass="ui-button-danger" style="margin-left: 5px;"
                                             update=":confirmStergeVoluntarDialog"> <!-- AM MODIFICAT AICI -->
                                <f:setPropertyActionListener value="#{voluntar}"
                                                             target="#{dashboardSecretarBean.selectedVoluntar}"/>
                            </p:commandButton>
                        </p:column>

                    </p:dataTable>
                </h:form>
            </p:tab>

            <p:tab title="Prezența Adunare Generală">
                <h:form id="sedinteForm">
                    <p:panel header="Management Prezență">
                        <p:commandButton value="Creează Prezență Nouă" icon="pi pi-plus"
                                         oncomplete="PF('prezentaDialog').show()"
                                         actionListener="#{dashboardSecretarBean.initPrezentaNoua}"
                                         update=":prezentaDialogForm"/>
                    </p:panel>
                    <p:dataTable id="sedinteTable" var="info" value="#{dashboardSecretarBean.sedinteDTO}"
                                 style="margin-top: 20px;"
                                 emptyMessage="Nu există ședințe înregistrate."
                                 paginator="true" rows="10"
                                 paginatorPosition="bottom"
                                 paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                 rowsPerPageTemplate="5,10,15">

                        <p:column headerText="Data Ședinței" sortBy="#{info.sedinta.dataSedinta}" style="width: 130px;">
                            <h:outputText value="#{info.sedinta.dataSedinta}">
                                <f:convertDateTime pattern="dd.MM.yyyy HH:mm" type="localDateTime"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Tip Ședință" style="width: 120px;">
                            <h:outputText value="#{info.sedinta.tipSedinta == 'ADUNARE_GENERALA' ? 'Adunare Generală' : 'Departament'}" />
                        </p:column>

                        <p:column headerText="Prezenți / Total" style="width: 100px; text-align:center;">
                            <h:outputText value="#{info.numarPrezentiSiOnline} / #{info.numarTotalVoluntari}" />
                        </p:column>

                        <p:column headerText="MS (50%+1)" style="width: 120px; text-align:center;">
                            <p:tag severity="#{info.majoritateSimpla ? 'success' : 'danger'}"
                                   value="#{info.majoritateSimpla ? 'Îndeplinită' : 'N/A'}"
                                   rounded="true"/>
                        </p:column>

                        <p:column headerText="ME (75%)" style="width: 120px; text-align:center;">
                            <p:tag severity="#{info.majoritateExtraordinara ? 'success' : 'danger'}"
                                   value="#{info.majoritateExtraordinara ? 'Îndeplinită' : 'N/A'}"
                                   rounded="true"/>
                        </p:column>

                    </p:dataTable>
                </h:form>
            </p:tab>
            <p:tab title="Generare Rapoarte">
                <h:form id="rapoarteForm">
                    <p:panel header="Rapoarte disponibile">
                        <p:panelGrid columns="2" styleClass="ui-panelgrid-blank" layout="grid">
                            <h:outputText value="Listă cu toți voluntarii :"/>
                            <p:commandButton value="Generează PDF" ajax="false"
                                             onclick="PrimeFaces.monitorDownload(start, stop);"
                                             styleClass="ui-button-danger">
                                <p:fileDownload value="#{dashboardSecretarBean.genereazaRaportVoluntariFull()}"/>
                            </p:commandButton>
                            <h:outputText value="Listă cu toți voluntarii activi:"/>
                            <p:commandButton value="Generează PDF" ajax="false"
                                             onclick="PrimeFaces.monitorDownload(start, stop);"
                                             styleClass="ui-button-success">
                                <p:fileDownload value="#{dashboardSecretarBean.genereazaRaportVoluntariActivi()}"/>
                            </p:commandButton>
                            <h:outputText value="Listă cu toți voluntarii colaboratori:"/>
                            <p:commandButton value="Generează PDF" ajax="false"
                                             onclick="PrimeFaces.monitorDownload(start, stop);"
                                             styleClass="ui-button-secondary">
                                <p:fileDownload
                                        value="#{dashboardSecretarBean.genereazaRaportVoluntariColaboratori()}"/>
                            </p:commandButton>
                            <h:outputText value="Listă cu toți voluntarii inactivi:"/>
                            <p:commandButton value="Generează PDF" ajax="false"
                                             onclick="PrimeFaces.monitorDownload(start, stop);"
                                             styleClass="ui-button-warning">
                                <p:fileDownload value="#{dashboardSecretarBean.genereazaRaportVoluntariInactivi()}"/>
                            </p:commandButton>
                            <h:outputText value="Listă cu structura departamentelor:"/>
                            <p:commandButton value="Generează PDF" ajax="false" styleClass="ui-button-help">
                                <p:fileDownload value="#{dashboardSecretarBean.genereazaRaportDepartamente()}"/>
                            </p:commandButton>
                        </p:panelGrid>
                    </p:panel>
                </h:form>
            </p:tab>
        </p:tabView>

        <p:dialog id="editDialogComponent" header="Editare Voluntar" widgetVar="editDialog" modal="true"
                  resizable="false" width="500">
            <h:form id="editVoluntarForm">
                <p:outputPanel id="editPanel" rendered="#{not empty dashboardSecretarBean.selectedVoluntar}">
                    <p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank">
                        <p:outputLabel value="Nume:"/>
                        <h:outputText value="#{dashboardSecretarBean.sedintaCurenta.dataSedinta}">
                            <f:convertDateTime pattern="dd.MM.yyyy HH:mm" type="localDateTime" />
                        </h:outputText>
                        <p:outputLabel for="departament" value="Departament:"/>
                        <p:selectOneMenu id="departament" value="#{dashboardSecretarBean.selectedVoluntar.departament}"
                                         converter="omnifaces.SelectItemsConverter" style="width:100%;">
                            <f:selectItem itemLabel="Fără departament" itemValue="#{null}" noSelectionOption="true"/>
                            <f:selectItems value="#{dashboardSecretarBean.departamente}" var="d" itemLabel="#{d.nume}"
                                           itemValue="#{d}"/>
                        </p:selectOneMenu>
                        <p:outputLabel for="rol" value="Rol:"/>
                        <p:selectOneMenu id="rol" value="#{dashboardSecretarBean.selectedVoluntar.user.rol}">
                            <f:selectItems value="#{dashboardSecretarBean.roluriAtribuibile}" var="r" itemLabel="#{r}"
                                           itemValue="#{r}"/>
                        </p:selectOneMenu>
                        <p:outputLabel for="status" value="Status:"/>
                        <p:selectOneMenu id="status" value="#{dashboardSecretarBean.selectedVoluntar.status}">
                            <f:selectItems value="#{dashboardSecretarBean.statusValues}" var="s" itemLabel="#{s}"
                                           itemValue="#{s}"/>
                        </p:selectOneMenu>
                    </p:panelGrid>
                    <br/>
                    <p:commandButton value="Salvează"
                                     actionListener="#{dashboardSecretarBean.salveazaModificariVoluntar}"
                                     oncomplete="PF('editDialog').hide()"/>
                    <p:commandButton value="Anulează" type="button" onclick="PF('editDialog').hide()"
                                     styleClass="ui-button-secondary"/>
                </p:outputPanel>
            </h:form>
        </p:dialog>

        <p:dialog header="Înregistrare Prezență" widgetVar="prezentaDialog" modal="true" width="700" height="500"
                  resizable="false">
            <h:form id="prezentaDialogForm">
                <p:outputPanel style="margin-bottom: 10px;"
                               rendered="#{not empty dashboardSecretarBean.sedintaCurenta}">
                    <h:outputText value="Ședință: #{dashboardSecretarBean.sedintaCurenta.descriere}"
                                  style="font-weight: bold;"/>
                    <br/>
                    <h:outputText value="Data: "/>
                    <h:outputText value="#{dashboardSecretarBean.sedintaCurenta.dataSedinta}">
                        <f:convertDateTime pattern="dd.MM.yyyy HH:mm"/>
                    </h:outputText>
                </p:outputPanel>
                <p:dataTable var="voluntar" value="#{dashboardSecretarBean.voluntari}" scrollable="true"
                             scrollHeight="350">
                    <p:column headerText="Nume Voluntar">
                        <h:outputText value="#{voluntar.numeComplet}"/>
                    </p:column>
                    <p:column headerText="Status Prezență">
                        <p:selectOneRadio id="statusPrezenta" value="#{dashboardSecretarBean.prezenteMap[voluntar.id]}">
                            <f:selectItems value="#{dashboardSecretarBean.statusPrezentaValues}" var="sp"
                                           itemLabel="#{sp}" itemValue="#{sp}"/>
                        </p:selectOneRadio>
                    </p:column>
                </p:dataTable>
                <f:facet name="footer">
                    <p:commandButton value="Salvează Prezența" action="#{dashboardSecretarBean.salveazaPrezenta}"
                                     oncomplete="PF('prezentaDialog').hide();"
                                     update=":voluntarForm:voluntariTable :messages"/>
                    <p:commandButton value="Anulează" type="button" onclick="PF('prezentaDialog').hide();"
                                     styleClass="ui-button-secondary"/>
                </f:facet>
            </h:form>
        </p:dialog>

        <script type="text/javascript">
            function start(){PF('statusDialog').show()} function stop(){PF('statusDialog').hide()}
        </script>
        <p:dialog modal="true" widgetVar="statusDialog" header="Se generează..." draggable="false" closable="false"
                  resizable="false"><i class="pi pi-spinner pi-spin" style="font-size:3rem"></i></p:dialog>
        <p:dialog header="Editare Departament" widgetVar="editDepartamentDialog" modal="true" resizable="false"
                  width="600">
            <h:form id="editDepartamentForm">
                <p:outputPanel id="editDepartamentPanel"
                               rendered="#{not empty dashboardSecretarBean.selectedDepartament}">
                    <p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank"
                                 columnClasses="ui-g-4, ui-g-8">

                        <p:outputLabel value="ID:"/>
                        <h:outputText value="#{dashboardSecretarBean.selectedDepartament.id}" style="font-weight:bold"/>

                        <p:outputLabel for="deptNumeEdit" value="Nume Departament:"/>
                        <p:inputText id="deptNumeEdit" value="#{dashboardSecretarBean.selectedDepartament.nume}"
                                     required="true" style="width:100%"/>

                        <p:outputLabel for="deptDescEdit" value="Descriere:"/>
                        <p:inputTextarea id="deptDescEdit"
                                         value="#{dashboardSecretarBean.selectedDepartament.descriere}" rows="3"
                                         style="width:100%"/>

                        <p:outputLabel for="deptCoordEdit" value="Coordonator:"/>
                        <p:selectOneMenu id="deptCoordEdit"
                                         value="#{dashboardSecretarBean.selectedDepartament.coordonator}"
                                         converter="omnifaces.SelectItemsConverter" style="width:100%;">
                            <f:selectItem itemLabel="Fără coordonator" itemValue="#{null}" noSelectionOption="true"/>
                            <f:selectItems value="#{dashboardSecretarBean.coordonatoriDisponibili}" var="c"
                                           itemLabel="#{c.numeComplet}" itemValue="#{c}"/>
                        </p:selectOneMenu>
                    </p:panelGrid>
                    <br/>
                    <p:commandButton value="Salvează Modificările"
                                     actionListener="#{dashboardSecretarBean.salveazaModificariDepartament}"
                                     oncomplete="PF('editDepartamentDialog').hide()"/>
                    <p:commandButton value="Anulează" type="button" onclick="PF('editDepartamentDialog').hide()"
                                     styleClass="ui-button-secondary"/>
                </p:outputPanel>
            </h:form>
        </p:dialog>

        <p:dialog header="Adaugă Departament" widgetVar="addDepartamentDialog" modal="true" resizable="false"
                  width="600">
            <h:form id="addDepartamentForm">
                <p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank" columnClasses="ui-g-4,ui-g-8">

                    <p:outputLabel for="numeDeptAdd" value="Nume Departament:"/>
                    <p:inputText id="numeDeptAdd" value="#{dashboardSecretarBean.newDepartament.nume}" required="true"
                                 style="width:100%"/>

                    <p:outputLabel for="descDeptAdd" value="Descriere:"/>
                    <p:inputTextarea id="descDeptAdd" value="#{dashboardSecretarBean.newDepartament.descriere}" rows="4"
                                     style="width:100%"/>

                    <p:outputLabel for="coordAdd" value="Alege Coordonator:"/>
                    <p:selectOneMenu id="coordAdd" value="#{dashboardSecretarBean.newDepartament.coordonator}"
                                     converter="omnifaces.SelectItemsConverter" style="width:100%;">
                        <f:selectItem itemLabel="Fără coordonator" itemValue="#{null}" noSelectionOption="true"/>
                        <f:selectItems value="#{dashboardSecretarBean.coordonatoriDisponibili}" var="c"
                                       itemLabel="#{c.numeComplet}" itemValue="#{c}"/>
                    </p:selectOneMenu>

                </p:panelGrid>
                <br/>
                <p:commandButton value="Salvează Departament"
                                 actionListener="#{dashboardSecretarBean.adaugaDepartament}"
                                 oncomplete="if (!args.validationFailed) PF('addDepartamentDialog').hide()"
                                 update=":departamentListForm :messages addDepartamentForm"/>
                <p:commandButton value="Anulează" type="button" onclick="PF('addDepartamentDialog').hide()"
                                 styleClass="ui-button-secondary"/>
            </h:form>
        </p:dialog>

        <p:dialog header="Confirmare Ștergere" widgetVar="confirmStergeDialog" modal="true" resizable="false"
                  width="400">
            <h:form id="confirmDeleteForm">
                <div style="text-align: center; padding: 10px;">
                    <i class="pi pi-exclamation-triangle"
                       style="font-size: 3rem; color: #f9a825; margin-bottom: 10px;"></i>
                    <p>Ești sigur că vrei să ștergi departamentul?
                    </p>
                    <p style="font-size: 0.9em; color: #6c757d;">
                        Această acțiune nu poate fi anulată.
                    </p>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <p:commandButton value="Da, Șterge"
                                     actionListener="#{dashboardSecretarBean.stergereDepartament}"
                                     oncomplete="PF('confirmStergeDialog').hide()"
                                     styleClass="ui-button-danger"/>
                    <p:commandButton value="Anulează" type="button"
                                     onclick="PF('confirmStergeDialog').hide()"
                                     styleClass="ui-button-secondary" style="margin-left: 5px;"/>
                </div>
            </h:form>
        </p:dialog>

        <p:dialog id="confirmStergeVoluntarDialog" header="Confirmare Ștergere Voluntar"
                  widgetVar="confirmStergeVoluntarDialog" modal="true" resizable="false" width="500">
            <h:form id="confirmDeleteVoluntarForm">
                <p:outputPanel id="deleteVoluntarPanel" rendered="#{not empty dashboardSecretarBean.selectedVoluntar}">
                    <div style="text-align: center; padding: 10px;">
                        <i class="pi pi-exclamation-triangle"
                           style="font-size: 3rem; color: #f9a825; margin-bottom: 10px;"></i>
                        <p>Ești sigur că vrei să ștergi definitiv voluntarul
                            <strong>"#{dashboardSecretarBean.selectedVoluntar.numeComplet}"</strong>?
                        </p>
                        <p style="font-size: 0.9em; color: #6c757d;">
                            Acțiunea este ireversibilă și va șterge și contul de utilizator asociat!
                        </p>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <p:commandButton value="Da, Șterge"
                                         action="#{dashboardSecretarBean.executaStergereVoluntar}"
                                         ajax="false"
                                         styleClass="ui-button-danger"/>
                        <p:commandButton value="Anulează" type="button"
                                         onclick="PF('confirmStergeVoluntarDialog').hide()"
                                         styleClass="ui-button-secondary" style="margin-left: 5px;"/>
                    </div>
                </p:outputPanel>
            </h:form>
        </p:dialog>
    </ui:define>
</ui:composition>